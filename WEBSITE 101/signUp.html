<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up Page</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8aUgQZGH-mpD6RMVSFGPHtDKsj4JD3UU",
            authDomain: "lvl999.firebaseapp.com",
            projectId: "lvl999",
            storageBucket: "lvl999.appspot.com",
            messagingSenderId: "421537934591",
            appId: "1:421537934591:web:9f97c884ae2bac649730ca",
            measurementId: "G-79VD61SH3R"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function validateForm() {
            let isValid = true;
            const fields = ['first_name', 'last_name', 'email', 'password', 'confirm_password'];

            fields.forEach(function (field) {
                const input = document.getElementById(field);
                const errorSpan = document.getElementById(field + '_error');

                if (input.value.trim() === '') {
                    input.classList.add('input-error');
                    errorSpan.style.display = 'block';
                    isValid = false;
                } else {
                    input.classList.remove('input-error');
                    errorSpan.style.display = 'none';
                }
            });

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (password !== confirmPassword) {
                document.getElementById('confirm_password_error').textContent = "Passwords do not match!";
                document.getElementById('confirm_password_error').style.display = 'block';
                document.getElementById('confirm_password').classList.add('input-error');
                isValid = false;
            }

            if (!validatePasswordPolicy(password)) {
                document.getElementById('password_error').textContent = "Password must be at least 8 characters long, include one special character, one number, and one uppercase letter.";
                document.getElementById('password_error').style.display = 'block';
                document.getElementById('password').classList.add('input-error');
                isValid = false;
            }

            return isValid;
        }

        function validatePasswordPolicy(password) {
            const lengthValid = password.length >= 8;
            const specialCharValid = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            const numberValid = /\d/.test(password);
            const upperCaseValid = /[A-Z]/.test(password);

            return lengthValid && specialCharValid && numberValid && upperCaseValid;
        }

        async function signUp() {
            if (!validateForm()) {
                return false; // Prevent form submission if validation fails
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const firstName = document.getElementById('first_name').value;
            const lastName = document.getElementById('last_name').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Store additional user info in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    firstName: firstName,
                    lastName: lastName,
                    email: email
                });

                alert('Sign-up successful! Redirecting to homepage...');
                localStorage.setItem('userName', firstName); // Store user's first name in local storage
                window.location.href = "Homepage.html"; // Redirect to the homepage
            } catch (error) {
                alert("Error: " + error.message);
            }

            return false; // Prevent form submission
        }

        document.getElementById("submit").addEventListener("click", function (event) {
            event.preventDefault();
            signUp();
        });

        window.onload = function () {
            const userName = localStorage.getItem('userName');
            if (userName) {
                document.querySelector('h1').textContent = "Welcome, " + userName + "!";
            }
        };
    </script>
</head>
<body>
    <h1>Sign Up</h1>
    <div>
        <form id="signup-form" onsubmit="return signUp()">
            <div class="form-group">
                <input type="text" id="first_name" name="first_name" required>
                <label for="first_name">Name</label>
                <span class="error-message" id="first_name_error">Name is required</span>
            </div>
            <div class="form-group">
                <input type="text" id="last_name" name="last_name" required>
                <label for="last_name">Surname</label>
                <span class="error-message" id="last_name_error">Surname is required</span>
            </div>
            <div class="form-group">
                <input type="email" id="email" name="email" required>
                <label for="email">Email Address</label>
                <span class="error-message" id="email_error">Email is required</span>
            </div>
            <div class="form-group">
                <span class="error-message" id="password_error">Password is required</span>
                <span class="password-hint" id="password_hint">
                    Must be at least 8 characters long, include one special character, one number, and one uppercase letter.
                </span>
                <input type="password" id="password" name="password" required>
                <label for="password">Create a password</label>
            </div>
            <div class="form-group">
                <input type="password" id="confirm_password" name="confirm_password" required>
                <label for="confirm_password">Confirm the password</label>
                <span class="error-message" id="confirm_password_error">Please confirm your password</span>
            </div>
            <button id="submit" type="submit">Submit</button>
        </form>
    </div>
</body>
</html>
